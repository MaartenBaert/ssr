#!/bin/bash
# Run this if you just want to build and install the program and you don't care about all the details.
# Any additional arguments will be passed on to 'cmake'.
# The following environment variables can be set to TRUE or FALSE to override the auto-detected values:
#  - ENABLE_32BIT_GLINJECT
#  - ENABLE_X86_ASM
#  - ENABLE_FFMPEG_VERSIONS
#  - WITH_QT5
#  - WITH_GLINJECT
#  - CMAKE_POLICY_VERSION_MINIMUM (default: 3.5)
# Use --no-install or -n to build without installing

set -e
cd "$( dirname "${BASH_SOURCE[0]}" )"

# Parse command line arguments
NO_INSTALL=false
CMAKE_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--no-install)
            NO_INSTALL=true
            shift
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS] [CMAKE_ARGS...]"
            echo ""
            echo "Options:"
            echo "  -n, --no-install    Build without installing"
            echo "  -h, --help          Show this help message"
            echo ""
            echo "Environment variables:"
            echo "  ENABLE_32BIT_GLINJECT   TRUE or FALSE (default: auto-detected)"
            echo "  ENABLE_X86_ASM          TRUE or FALSE (default: auto-detected)"
            echo "  ENABLE_FFMPEG_VERSIONS  TRUE or FALSE (default: auto-detected)"
            echo "  WITH_QT5                TRUE or FALSE (default: auto-detected)"
            echo "  WITH_GLINJECT           TRUE or FALSE (default: auto-detected)"
            echo ""
            echo "Any additional arguments are passed to cmake."
            exit 0
            ;;
        *)
            CMAKE_ARGS+=("$1")
            shift
            ;;
    esac
done

if [ x"$( whoami )" = x"root" ]; then
	echo "Error: don't run this script as root, this will mess up file permissions"
	exit 1
fi

export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/lib64/pkgconfig:/usr/local/lib/pkgconfig"

if [ -z "$ENABLE_32BIT_GLINJECT" ] || [ -z "$ENABLE_X86_ASM" ] || [ -z "$WITH_GLINJECT" ]; then
	echo "Detecting architecture ..."
	case "$( uname -m )" in
		"i386"|"i486"|"i586"|"i686")
			: ${ENABLE_32BIT_GLINJECT:="FALSE"}
			: ${ENABLE_X86_ASM:="TRUE"}
			: ${WITH_GLINJECT:="TRUE"}
			;;
		"x86_64")
			: ${ENABLE_32BIT_GLINJECT:="FALSE"}
			: ${ENABLE_X86_ASM:="TRUE"}
			: ${WITH_GLINJECT:="TRUE"}
			;;
		*)
			: ${ENABLE_32BIT_GLINJECT:="FALSE"}
			: ${ENABLE_X86_ASM:="FALSE"}
			: ${WITH_GLINJECT:="FALSE"}
			;;
	esac
fi

# Check if 32-bit libraries are available if ENABLE_32BIT_GLINJECT is TRUE
if [ x"$ENABLE_32BIT_GLINJECT" == x"TRUE" ]; then
    echo "Checking for 32-bit development libraries..."
    if ! dpkg --print-foreign-architectures 2>/dev/null | grep -q i386 && \
       ! ls /usr/lib/i386-linux-gnu/ 2>/dev/null && \
       ! ls /usr/lib32/ 2>/dev/null; then
        echo "  Warning: 32-bit development libraries not found. Disabling 32-bit GLInject."
        echo "  To enable 32-bit support, install 32-bit development libraries first."
        ENABLE_32BIT_GLINJECT="FALSE"
    fi
fi

if [ -z "$ENABLE_FFMPEG_VERSIONS" ]; then
	echo "Detecting ffmpeg/libav ..."
	if ! pkg-config --exists libavcodec; then
		echo "  Error: libavcodec development package not found, make sure ffmpeg or libav development packages are installed."
		exit 1
	fi
	LIBAVCODEC_INCLUDE_DIR="$( pkg-config --variable=includedir libavcodec )"
	HAS_FFMPEG=$( grep -c "This file is part of FFmpeg." $LIBAVCODEC_INCLUDE_DIR/libavcodec/avcodec.h || true )
	HAS_LIBAV=$( grep -c "This file is part of Libav." $LIBAVCODEC_INCLUDE_DIR/libavcodec/avcodec.h || true )
	if [ $HAS_FFMPEG -gt 0 ]; then
		if [ $HAS_LIBAV -gt 0 ]; then
			echo "  Error: Detected ffmpeg AND libav, this should not happen!"
			exit 1
		else
			echo "  Detected ffmpeg."
			ENABLE_FFMPEG_VERSIONS="TRUE"
		fi
	else
		if [ $HAS_LIBAV -gt 0 ]; then
			echo "  Detected libav."
			ENABLE_FFMPEG_VERSIONS="FALSE"
		else
			echo "  Error: Detection failed."
			exit 1
		fi
	fi
fi

if [ -z "$WITH_QT5" ]; then
	echo "Detecting Qt version ..."
	if pkg-config --exists "Qt5Gui >= 5.7"; then
		echo "  Detected Qt5 (version $( pkg-config --modversion Qt5Gui ))."
		WITH_QT5="TRUE"
	elif pkg-config --exists "QtGui >= 4.8"; then
		echo "  Detected Qt4 (version $( pkg-config --modversion QtGui ))."
		WITH_QT5="FALSE"
	else
		echo "  Error: Qt development package not found, make sure that either Qt4 (4.8 or newer) or Qt5 (5.7 or newer) is installed."
		exit 1
	fi
fi

echo "Auto-detected options:"
echo "  ENABLE_32BIT_GLINJECT = $ENABLE_32BIT_GLINJECT"
echo "  ENABLE_X86_ASM = $ENABLE_X86_ASM"
echo "  ENABLE_FFMPEG_VERSIONS = $ENABLE_FFMPEG_VERSIONS"
echo "  WITH_QT5 = $WITH_QT5"
echo "  WITH_GLINJECT = $WITH_GLINJECT"
echo "  CMAKE_POLICY_VERSION_MINIMUM = ${CMAKE_POLICY_VERSION_MINIMUM:-3.5}"
echo "  NO_INSTALL = $NO_INSTALL"

PREFIX="/usr"

OPTIONS=()
OPTIONS+=("-DENABLE_32BIT_GLINJECT=$ENABLE_32BIT_GLINJECT")
OPTIONS+=("-DENABLE_X86_ASM=$ENABLE_X86_ASM")
OPTIONS+=("-DENABLE_FFMPEG_VERSIONS=$ENABLE_FFMPEG_VERSIONS")
OPTIONS+=("-DWITH_QT5=$WITH_QT5")
OPTIONS+=("-DWITH_GLINJECT=$WITH_GLINJECT")

if [ x"$WITH_QT5" == x"TRUE" ]; then
	export QT_SELECT="qt5"
else
	export QT_SELECT="qt4"
	OPTIONS+=("-DCMAKE_AUTOMOC_MOC_OPTIONS=-D_SYS_SYSMACROS_H_OUTER")
fi

echo "Entering build-release directory ..."
rm -rf build-release
mkdir build-release
cd build-release

echo "Running cmake ..."
CMAKE_POLICY_VERSION_MINIMUM="${CMAKE_POLICY_VERSION_MINIMUM:-3.5}" cmake -DCMAKE_INSTALL_PREFIX="$PREFIX" -DCMAKE_BUILD_TYPE=Release "${OPTIONS[@]}" "${CMAKE_ARGS[@]}" ..

echo "Compiling ..."
make -j "$( nproc )"

if [ "$NO_INSTALL" = true ]; then
    echo "Skipping installation (--no-install flag specified)"
    echo "Build completed successfully. Executable is at: $(pwd)/src/simplescreenrecorder"
    echo "Leaving build-release directory ..."
    cd ..
    echo "Done."
    exit 0
fi

if [ x"$WITH_GLINJECT" == x"TRUE" ]; then
	echo "Removing old GLInject libraries ..."
	sudo rm -f "/usr/lib/libssr-glinject."*
	sudo rm -f "/usr/lib64/libssr-glinject."*
	sudo rm -f "/usr/lib/x86_64-linux-gnu/libssr-glinject."*
	if [ x"$ENABLE_32BIT_GLINJECT" == x"TRUE" ]; then
		sudo rm -f "/usr/lib32/libssr-glinject."*
		sudo rm -f "/usr/lib/i386-linux-gnu/libssr-glinject."*
		sudo rm -f "/usr/lib/i686-linux-gnu/libssr-glinject."*
	fi
fi

echo "Installing ..."
sudo make install

echo "Leaving build-release directory ..."
cd ..

echo "Running post-install script ..."
sudo ./postinstall

echo "Done."
